app.controller('usuaLgonCtrl', function($rootScope, $scope, $q, srv, comc, ctxl) {

	//*************************************************************************************************************//
	//*************************************************************************************************************//
	//****************************************                             ****************************************//
	//****************************************  FUNCIONES DE ARQUITECTURA  ****************************************//
	//****************************************                             ****************************************//
	//*************************************************************************************************************//
	//*************************************************************************************************************//

	//*************************************************************************************************************//
	// Carga de vista                                                                                              //
	//*************************************************************************************************************//
	function loadView() {
		inicForm();
		$scope.cntx.conf.set('mode', 'L');
		view();
	}

	//*************************************************************************************************************//
	// Carga de vista, en transición de retorno                                                                    //
	//*************************************************************************************************************//
	function loadViewBack() {
		//Sin acciones adicionales
	}
	
	//*************************************************************************************************************//
	// Carga de vista, en transición con datos                                                                     //
	//*************************************************************************************************************//
	function loadViewGo() {
		var view = srv.getOrigView();
		
		//Si venimos del registro, hacemos login automático
		if (view === 'usua/regi') {
			var usua = $scope.cntx.xchg.get('usua');
			if (usua !== 'undefined' && usua !== null) {
				$scope.cntx.form.get('iden').data = usua.iden;
				$scope.cntx.form.get('pass').data = usua.pass;
				$scope.fnLgon();
			} else {
				loadView();
			}
		} else {
			loadView();
		}
	}

	//*************************************************************************************************************//
	// Función encargada de manejar la vista y sus modos de presentación                                           //
	// - 'L': Vista de login                                                                                       //
	//*************************************************************************************************************//
	function view() {
		if ($scope.cntx.conf.get('mode') === 'L') {
			ctxl.formField($scope.cntx, 'iden', true, false);
			ctxl.formField($scope.cntx, 'pass', true, false);
		} else {
			ctxl.formField($scope.cntx, 'iden', false, false);
			ctxl.formField($scope.cntx, 'pass', false, false);
		}
	}
	
	//*************************************************************************************************************//
	// Función de inicialización del formulario de la vista                                                        //
	//*************************************************************************************************************//
	function inicForm() {
		$scope.cntx.form.get('iden').data = '';
		$scope.cntx.form.get('pass').data = '';
	}

	//*************************************************************************************************************//
	//*************************************************************************************************************//
	//***************************************                                **************************************//
	//***************************************  FUNCIONES DE MANEJO DE VISTA  **************************************//
	//***************************************                                **************************************//
	//*************************************************************************************************************//
	//*************************************************************************************************************//

	//*************************************************************************************************************//
	// Captura del evento de login en la aplicación.                                                               //
	//*************************************************************************************************************//
	$scope.fnLgon = function() {
		//Realizamos el login en backend
		var srv1 = comc.request('usua/lgon', $scope.cntx);
		$q.all([srv.stResp(true, srv1)]).then(function(){
			//Establecemos los datos de la sesión en FrontEnd
			$rootScope.esta.sesi     = $scope.cntx.data.get('sesi');
			$rootScope.esta.lgonUsua = true;
			$rootScope.esta.usua     = $scope.cntx.data.get('usua');
			
			//Volvemos a solicitar el menú, para obtener el correspondiente al usuario activo
			var srv2 = comc.request('menu/make', null);
			$q.all([srv.stResp(true, srv2)]).then(function() {
				//Transición al home
				srv.go(null, null, '/', null);
			})
		});
	};

	//*************************************************************************************************************//
	//*************************************************************************************************************//
	//*********************************************                  **********************************************//
	//*********************************************  CARGA DE VISTA  **********************************************//
	//*********************************************                  **********************************************//
	//*************************************************************************************************************//
	//*************************************************************************************************************//
	
	//Generamos el contexto de la vista
	$scope.cntx = srv.getCntx('/lgon');

	if (srv.goTran()) {
		loadViewGo();
	} else if (srv.backTran()) {
		loadViewBack();
	} else {
		loadView();
	}

});